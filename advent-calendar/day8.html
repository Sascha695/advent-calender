<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>6. Dezember â€“ Nikolaus im harten Labyrinth</title>
<style>
  :root{
    /* 31 Spalten = 29 Level + 2 Waldrand */
    --cols: 31;
    /* Zelle so, dass sie auf Handybreite passt (max 22px) */
    --cell: min(22px, calc((100vw - 24px) / 31));
    --gap: 2px;

    --wall:#0f172a;
    --path:#ffffff;
    --path-dim:#cbd5e1;
    --forest:#166534;
    --house:#ffd54f;
    --grid-outline:#00000033;
    --player-scale: 1.2;
    --goal-scale: 1.05;
  }

  /* Fixierter Hintergrund als eigene Ebene */
  .bg-fixed{
    position:fixed;
    inset:0;
    z-index:0;
    background-repeat:no-repeat;
    background-size:cover;
    background-position:center;
    background-attachment:fixed;
  }

  .bg-overlay{
    position:fixed;
    inset:0;
    pointer-events:none;
    background:linear-gradient(0deg, rgba(0,0,0,.16), rgba(0,0,0,.16));
    z-index:0;
  }

  html, body{
    margin:0;
    padding:0;
    height:100%;
  }

  body{
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:#111;
    background:none;
    overflow:hidden;        /* Body scrollt nicht */
  }

  .page{
    position:relative;
    height:100vh;
    overflow-y:auto;        /* nur dieser Container scrollt */
    -webkit-overflow-scrolling:touch;
  }

  header,main,footer{ position:relative; z-index:1; }
  header,footer{padding:10px 8px; text-align:center}

  h1{margin:0 0 6px; font-size:1.1rem}
  .sub{opacity:.9; font-size:.95rem}
  .intro{
    margin:8px auto 0;
    max-width:800px;
    padding:8px 10px;
    background:#fff;
    border:1px solid #dbe2ea;
    border-radius:10px;
    line-height:1.35;
  }

  .wrap{display:grid; place-items:center; padding:8px; gap:8px}
  .bar{display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap}
  .bar button{padding:8px 12px; border-radius:10px; border:1px solid #b8c1cc; background:#fff; font:inherit; cursor:pointer;}

  .frame{
    padding:6px;
    border-radius:14px;
    background:rgba(255,255,255,.65);
    box-shadow:0 10px 28px rgba(0,0,0,.18), inset 0 0 0 2px var(--grid-outline);
    max-width:100vw;
    overflow:visible;
  }

  .maze{
    display:grid;
    grid-template-columns:repeat(var(--cols), var(--cell));
    grid-auto-rows:var(--cell);
    gap:var(--gap);
    touch-action: pan-y;
    outline:2px solid var(--grid-outline);
    outline-offset:4px;
    background:#fafafaAA;
    border-radius:10px;
    isolation:isolate;
  }

  .cell{
    width:var(--cell);
    height:var(--cell);
    border-radius:4px;
    position:relative;
    display:grid;
    place-items:center;
    user-select:none;
    overflow:visible;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
  }
  .wall{background:var(--wall)}
  .path{background:var(--path)}
  .path.dim{background:var(--path-dim)}
  .forest{background:var(--forest)}
  .goal{background:var(--house)}
  .goal.fallback::after{content:"ðŸ "; font-size:calc(var(--cell)*0.75);}
  .goal.dim{filter:brightness(.85)}

  .sprite{
    position:absolute;
    inset:50% auto auto 50%;
    transform:translate(-50%,-50%);
    width:calc(var(--cell)*var(--player-scale));
    height:calc(var(--cell)*var(--player-scale));
    display:grid;
    place-items:center;
    background-repeat:no-repeat;
    background-size:contain;
    background-position:center;
    pointer-events:none;
    text-shadow:0 1px 2px rgba(0,0,0,.35);
  }
  .sprite.emoji{ font-size:calc(var(--cell)*var(--player-scale)*0.9); }

  .hint{ font-size:.9rem; opacity:.9; margin:2px 0 0; text-align:center; }
  .controls{ display:grid; grid-template-areas: ". up ." "left center right" ". down ."; gap:8px; touch-action:none; }
  .btn{ grid-area:center; width:52px;height:52px;border-radius:12px;border:1px solid #b8c1cc;background:#fff;font-size:20px; }
  .btn:active{ transform:translateY(1px); } .up{grid-area:up}.down{grid-area:down}.left{grid-area:left}.right{grid-area:right}

  @media (max-width:400px){
    .btn{ width:46px; height:46px; font-size:18px; }
  }

  .fog{ background:#0b1220 !important; box-shadow:none !important; }
  .fog>*{display:none !important}

  .win{margin-top:6px; text-align:center; font-weight:bold;}
</style>
</head>
<body onkeydown="handleKey(event)">

<div id="bg" class="bg-fixed" aria-hidden="true"></div>
<div class="bg-overlay" aria-hidden="true"></div>

<div class="page">
  <header>
    <h1>6. Dezember â€“ Nikolaus im harten Labyrinth</h1>
    <div class="sub">Langer Umweg ums Haus, viele Sackgassen. AuÃŸenwald bleibt sichtbar.</div>
    <p class="intro">â€žVon drauÃŸen vom Walde, da komme ich her, aber ich habe leider den Weg zur EichbÃ¼hlstraÃŸe vergessen. Kannst du mir zeigen, wie ich zu deinem Haus komme?â€œ</p>
  </header>

  <main class="wrap">
    <div class="bar"><button id="regen">Neu erzeugen</button></div>

    <div class="frame">
      <div
        id="maze"
        class="maze"
        aria-label="Labyrinth"
        role="grid"
        tabindex="0"
        ontouchstart="onTouchStart(event)"
        ontouchmove="onTouchMove(event)"
        ontouchend="onTouchEnd(event)"
      ></div>
    </div>

    <p class="hint">Falls es zu schwer ist, dann ist hier eine Taschenlampe:</p>
    <div class="bar">
      <button id="fogToggle" class="toggle" aria-pressed="false">Sichtfeld AN</button>
    </div>

    <div class="controls" aria-label="Pfeiltasten">
      <button class="btn up"    aria-label="Nach oben"    onclick="move(-1,0)">â–²</button>
      <button class="btn left"  aria-label="Nach links"   onclick="move(0,-1)">â—€</button>
      <button class="btn"       aria-label="Zentrum" disabled>ðŸŽ…</button>
      <button class="btn right" aria-label="Nach rechts"   onclick="move(0,1)">â–¶</button>
      <button class="btn down"  aria-label="Nach unten"    onclick="move(1,0)">â–¼</button>
    </div>

    <div class="win" id="win" style="display:none">
      Geschafft! Merke dir den Buchstaben: <strong id="letter">N</strong>
    </div>
  </main>

  <footer><p><a href="index.html">ZurÃ¼ck zum Kalender</a></p></footer>
</div>

<script>
/* =====Bilder===== */
var backgroundImageURL = "assets/nikolaus_map.png";
var bgEl = document.getElementById('bg');
if (backgroundImageURL){
  var safeURL = encodeURI(backgroundImageURL);
  bgEl.style.backgroundImage = "url('" + safeURL + "')";
}

/* ===== Level (29x29, wie von dir) ===== */
var LEVEL = [
 [1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1],
 [1,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,1],
 [1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1,1],
 [1,0,1,0,1,1,1,0,1,0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,1],
 [1,0,1,0,1,0,0,0,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1],
 [1,0,1,0,1,1,1,1,1,0,1,1,0,0,0,0,0,0,1,1,0,1,1,1,1,1,0,1,1],
 [1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,0,0,0,1,0,1,1],
 [1,0,0,0,0,0,0,0,0,0,1,1,0,0,1,0,1,1,1,1,1,0,1,1,1,1,0,1,1],
 [1,0,0,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,0,0,0,0,1,0,1,1],
 [1,1,0,1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,1,0,1,1,0,1,0,1,1],
 [1,1,0,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0,0,0,1,1],
 [1,1,1,0,0,0,0,0,1,0,1,1,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1,1],
 [1,1,1,0,1,0,1,1,1,1,1,1,0,0,0,1,1,1,0,1,1,0,0,0,0,0,0,1,1],
 [1,1,1,0,1,0,0,0,0,1,0,1,0,1,1,1,1,1,0,1,1,1,1,0,1,1,0,1,1],
 [1,1,1,0,1,0,1,1,0,1,1,1,0,1,1,0,0,0,0,1,1,1,1,0,1,1,0,1,1],
 [1,1,1,0,1,0,1,0,0,1,0,0,0,1,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1],
 [1,1,1,1,1,0,0,1,0,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,0,1,1],
 [1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1],
 [1,1,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,1,1],
 [1,1,0,1,1,1,1,0,0,0,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,1,1,1],
 [1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,1,1,0,0,0,1,1,0,1,1,1,1,1,1],
 [1,1,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,1,0,1,0,0,0,0,1,1,1,1],
 [1,1,0,1,1,1,0,1,1,1,1,1,0,1,0,0,0,1,1,0,1,1,1,1,0,1,1,1,1],
 [1,1,0,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,0,0,0,1,1],
 [1,1,0,0,0,0,0,0,0,0,1,1,0,1,1,0,1,0,1,0,0,0,1,1,0,1,1,1,1],
 [1,1,0,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

var FOREST = 2, WALL = 1, PATH = 0;
var SIZE = 29;
var GRID = SIZE + 2;
var grid, position, goal;
var lampOn = false;
var FOG_RADIUS = 2;
var visited = {};   // "r,c" -> true

var mazeEl = document.getElementById('maze');
var regenBtn = document.getElementById('regen');
var fogBtn = document.getElementById('fogToggle');

regenBtn.onclick = function(){ generateAndDraw(); };
fogBtn.onclick = function(){
  lampOn = !lampOn;
  fogBtn.textContent = lampOn ? 'Sichtfeld AUS' : 'Sichtfeld AN';
  fogBtn.setAttribute('aria-pressed', String(lampOn));
  draw();
};

/* ===== Setup ===== */
generateAndDraw();

function generateAndDraw(){
  GRID = SIZE + 2;
  document.documentElement.style.setProperty('--cols', String(GRID));

  var result = buildGridWithForestAndEntrance();
  grid = result.grid;
  position = result.start;
  visited = {};
  visited[position.r + "," + position.c] = true;
  goal = computeFarthestGoal(grid, position);
  draw();
}

/* baue 31x31 mit Wald auÃŸen und Eingang oben an erster 0 in LEVEL-Zeile 0 */
function buildGridWithForestAndEntrance(){
  var n = SIZE;
  var g = [];
  var r,c;

  for(r=0; r<n+2; r++){
    g[r] = [];
    for(c=0; c<n+2; c++){
      if (r===0 || c===0 || r===n+1 || c===n+1){
        g[r][c] = FOREST;
      } else {
        g[r][c] = LEVEL[r-1][c-1];
      }
    }
  }

  var entranceInnerCol = -1;
  for(c=0;c<n;c++){
    if (LEVEL[0][c] === PATH){ entranceInnerCol = c; break; }
  }
  if (entranceInnerCol === -1) entranceInnerCol = Math.floor(n/2);

  var ec = entranceInnerCol + 1; // + Waldrand
  g[0][ec] = PATH;  // Ã–ffnung im Wald oben
  g[1][ec] = PATH;

  var start = {r:0, c:ec};
  return {grid:g, start:start};
}

/* BFS, weitester PATH vom Start ist das Ziel */
function computeFarthestGoal(g, start){
  var rows = g.length, cols = g[0].length;
  var dist = [];
  var r,c;
  for(r=0;r<rows;r++){
    dist[r] = [];
    for(c=0;c<cols;c++) dist[r][c] = -1;
  }
  var q = [];
  dist[start.r][start.c] = 0;
  q.push({r:start.r, c:start.c});
  var best = {r:start.r, c:start.c};
  var DIRS = [[1,0],[-1,0],[0,1],[0,-1]];
  while(q.length){
    var cur = q.shift();
    r = cur.r; c = cur.c;
    var d = dist[r][c];
    if (d > dist[best.r][best.c]) best = {r:r, c:c};
    for(var i=0;i<DIRS.length;i++){
      var nr = r + DIRS[i][0];
      var nc = c + DIRS[i][1];
      if (nr<0||nc<0||nr>=rows||nc>=cols) continue;
      if (g[nr][nc] !== PATH) continue;
      if (dist[nr][nc] !== -1) continue;
      dist[nr][nc] = d+1;
      q.push({r:nr,c:nc});
    }
  }
  return best;
}

/* ===== Render + Sichtfeld ===== */
function draw(){
  var vis = computeVisibilityStates();
  var seenEver = vis.seenEver;
  var fringeNow = vis.fringeNow;

  mazeEl.innerHTML = "";
  var r,c,v,cell;

  for(r=0;r<GRID;r++){
    for(c=0;c<GRID;c++){
      v = grid[r][c];
      cell = document.createElement('div');

      if (r===goal.r && c===goal.c){
        cell.className = 'cell goal';
      } else if (v===WALL){
        cell.className = 'cell wall';
      } else if (v===FOREST){
        cell.className = 'cell forest';
      } else {
        cell.className = 'cell path';
      }

      if (r===position.r && c===position.c){
        var s = document.createElement('div');
        s.className = 'sprite emoji';
        s.textContent = 'ðŸŽ…';
        s.setAttribute('aria-hidden','true');
        cell.classList.add('player');
        cell.appendChild(s);
      }

      if (!lampOn){
        if (!seenEver[r][c] && v !== FOREST) {
          cell.classList.add('fog');
        } else if (fringeNow[r][c] && (v===PATH || (r===goal.r && c===goal.c))){
          cell.classList.add('dim');
        }
      }

      mazeEl.appendChild(cell);
    }
  }
}

function computeVisibilityStates(){
  var seenEver = [], fringeNow = [];
  var r,c;
  for(r=0;r<GRID;r++){
    seenEver[r] = [];
    fringeNow[r] = [];
    for(c=0;c<GRID;c++){
      seenEver[r][c] = false;
      fringeNow[r][c] = false;
    }
  }

  if (lampOn){
    for(r=0;r<GRID;r++) for(c=0;c<GRID;c++) seenEver[r][c]=true;
    return {seenEver:seenEver, fringeNow:fringeNow};
  }

  for (var key in visited){
    if (!visited.hasOwnProperty(key)) continue;
    var parts = key.split(',');
    r = parseInt(parts[0],10);
    c = parseInt(parts[1],10);
    if (r>=0 && c>=0 && r<GRID && c<GRID) seenEver[r][c] = true;
  }

  var R = position.r, C = position.c;
  for(r=R-FOG_RADIUS;r<=R+FOG_RADIUS;r++){
    for(c=C-FOG_RADIUS;c<=C+FOG_RADIUS;c++){
      if (r>=0 && c>=0 && r<GRID && c<GRID){
        if (Math.max(Math.abs(r-R), Math.abs(c-C)) <= FOG_RADIUS){
          var key2 = r + "," + c;
          if (!visited[key2]) fringeNow[r][c] = true;
          seenEver[r][c] = true;
        }
      }
    }
  }
  return {seenEver:seenEver, fringeNow:fringeNow};
}

/* ===== Steuerung ===== */
function canMove(r,c){
  return !(r<0||c<0||r>=GRID||c>=GRID) && grid[r][c]!==WALL;
}

function move(dr,dc){
  if (!grid) return;
  var nr = position.r + dr;
  var nc = position.c + dc;
  if (!canMove(nr,nc)) return;
  position = {r:nr, c:nc};
  visited[nr + "," + nc] = true;
  draw();

  if (position.r===goal.r && position.c===goal.c){
    document.getElementById('win').style.display = 'block';
    document.getElementById('letter').textContent = 'N';
  }
}

function handleKey(e){
  var k = e.key;
  if (!k) return;
  k = k.toLowerCase();
  if (k==='arrowup' || k==='w'){ move(-1,0); }
  else if (k==='arrowdown' || k==='s'){ move(1,0); }
  else if (k==='arrowleft' || k==='a'){ move(0,-1); }
  else if (k==='arrowright' || k==='d'){ move(0,1); }
}

/* Touch-Steuerung: Wischen links/rechts */
var sx=0, sy=0, st=0;
var SWIPE_MIN=22, SWIPE_MAXT=600;

function onTouchStart(e){
  if (!e.touches || e.touches.length!==1) return;
  sx=e.touches[0].clientX;
  sy=e.touches[0].clientY;
  st=Date.now();
}
function onTouchMove(e){ /* ignorieren, nur zum Scrollen */ }
function onTouchEnd(e){
  var dt = Date.now()-st;
  if (dt>SWIPE_MAXT) return;
  var t = e.changedTouches && e.changedTouches[0];
  if (!t) return;
  var dx = t.clientX - sx;
  var dy = t.clientY - sy;
  if (Math.max(Math.abs(dx),Math.abs(dy))<SWIPE_MIN) return;
  if (Math.abs(dx)>Math.abs(dy)){
    if (dx>0) move(0,1); else move(0,-1);
    e.preventDefault();
  }
}
</script>
</body>
</html>
